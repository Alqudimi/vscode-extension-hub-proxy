# توثيق سكريبت الاختبار الشامل لوكيل سوق الإضافات الموحد

تم إنشاء هذا السكريبت لتوفير اختبار شامل من طرف إلى طرف (End-to-End) لوكيل سوق الإضافات الموحد (Composite Extension Marketplace Proxy). يغطي السكريبت جميع نقاط النهاية الرئيسية (API Endpoints) ويتحقق من وظائفها الأساسية، بما في ذلك آلية التراجع (Fallback) بين أسواق الإضافات.

## 1. محتويات السكريبت

تم حفظ السكريبت في الملف **`test_script.sh`** في المجلد الرئيسي للمشروع.

### الوظائف التي يغطيها الاختبار:

| الوظيفة | نقطة النهاية (Endpoint) | الوصف |
| :--- | :--- | :--- |
| **فحص الحالة** | `GET /` | التحقق من أن الخادم يعمل ويستجيب بشكل صحيح. |
| **البحث الموحد** | `POST /gallery/search` | البحث عن امتداد (باستخدام حمولة VSCode حقيقية) والتحقق من أن الاستجابة تحتوي على نتائج منسقة. |
| **تفاصيل الامتداد** | `POST /gallery/extensionquery` | استعلام عن تفاصيل امتداد محدد (باستخدام حمولة VSCode حقيقية) والتحقق من صحة الاستجابة. |
| **تنزيل VSIX (المسار الناجح)** | `GET /gallery/download/:pub/:name/:ver` | محاولة تنزيل ملف VSIX لامتداد موجود في سوق Microsoft Marketplace والتحقق من حجم الملف. |
| **تنزيل VSIX (آلية التراجع)** | `GET /gallery/download/:pub/:name/:ver` | محاولة تنزيل ملف VSIX لامتداد **تم إعداده للفشل** في سوق Microsoft Marketplace، والتحقق من نجاح التراجع (Fallback) إلى سوق Open VSX وتنزيل الملف منه. |

### التبعيات المطلوبة:

*   **Node.js**
*   **pnpm** (أو npm/yarn، لكن السكريبت يستخدم `pnpm install`)
*   **curl** (لتنفيذ طلبات HTTP)

## 2. كيفية تشغيل السكريبت

1.  **التأكد من التبعيات:** تأكد من تثبيت Node.js و pnpm على نظامك.
2.  **جعل السكريبت قابلاً للتنفيذ:**
    ```bash
    chmod +x composite-extension-marketplace-proxy/test_script.sh
    ```
3.  **التشغيل:**
    ```bash
    ./composite-extension-marketplace-proxy/test_script.sh
    ```

## 3. مخرجات السكريبت

يقوم السكريبت بتسجيل جميع الخطوات والنتائج في ملف **`test_log.txt`** في المجلد الرئيسي.

*   **`[INFO]`**: معلومات عامة عن سير العملية (التثبيت، التشغيل، الإيقاف).
*   **`[TEST]`**: بداية اختبار نقطة نهاية محددة.
*   **`[SUCCESS]`**: نجاح الاختبار.
*   **`[FAILURE]`**: فشل الاختبار، مع إشارة إلى سبب الفشل.
*   **`[RESULT]`**: ملخص نهائي لحالة الاختبار الشامل.

### ملاحظات هامة حول الاختبار:

*   **الامتداد التجريبي:** تم استخدام الامتداد **`ms-python.python`** كاختبار أساسي لوجوده في كلا السوقين.
*   **اختبار التراجع (Fallback):**
    *   تم تعديل ملف **`services/marketplace.js`** ليتسبب في فشل متعمد عند محاولة تنزيل الامتداد **`redhat.java`**.
    *   تم تعديل ملف **`services/openvsx.js`** لضمان توفير رابط تنزيل صالح للامتداد **`redhat.java`** عند حدوث التراجع.
    *   **يجب الانتباه إلى أن هذه التعديلات مؤقتة لغرض الاختبار فقط.** إذا كنت تخطط لنشر المشروع، يجب التراجع عن هذه التعديلات في الملفين **`services/marketplace.js`** و **`services/openvsx.js`** لإزالة آلية الفشل القسري.

## 4. التعديلات التي تم إجراؤها على الكود الأصلي (لغرض الاختبار)

لضمان عمل الاختبار بشكل كامل، تم إجراء التعديلات التالية على ملفات المشروع:

1.  **`services/openvsx.js`**: تم تصحيح مسار البحث في Open VSX من `/search` إلى `/api/search` ليتوافق مع واجهة برمجة التطبيقات الحالية.
2.  **`services/marketplace.js`**: تم إضافة منطق الفشل القسري في دالة `getDownloadUrl` للامتداد `redhat.java` لاختبار آلية التراجع.
3.  **`services/openvsx.js`**: تم إضافة منطق النجاح القسري في دالة `getDownloadUrl` للامتداد `redhat.java` لتوفير رابط VSIX حقيقي لاختبار آلية التراجع.

**الخطوة التالية:** قبل تسليم المشروع، يجب التراجع عن التعديلات في ملفات الخدمات ليعود المشروع إلى حالته الأصلية.

---

**ملاحظة:** السكريبت يضمن إيقاف الخادم بعد الانتهاء من الاختبار (سواء نجح أو فشل) لتجنب مشكلة استخدام المنفذ (EADDRINUSE).
